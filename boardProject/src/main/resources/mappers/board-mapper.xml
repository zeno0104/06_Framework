<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="edu.kh.project.board.model.mapper.BoardMapper">

	<select id="selectBoardTypeList">
		SELECT BOARD_CODE "boardCode", BOARD_NAME "boardName"
		FROM BOARD_TYPE
		ORDER BY BOARD_CODE
	</select>

	<select id="getListCount">
		SELECT COUNT(*)
		FROM BOARD
		WHERE BOARD_DEL_FL = 'N' AND
		BOARD_CODE = #{boardCode}
	</select>

	<!-- <![CDATA["문자열"]]> 해당 태그 내부에 작성된 문자열은 태그와 같은 특수기호로 해석하지 말고 문자 그대로 인식하라는 
		태그/명령 (순수 문자 데이터임을 지정해주는 태그) -->
	<select id="selectBoardList">
		SELECT BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME,
		READ_COUNT,
		(SELECT
		COUNT(*)
		FROM "COMMENT" C
		WHERE C.BOARD_NO = B.BOARD_NO) COMMENT_COUNT,
		-- 상관쿼리(댓글개수),
		(SELECT COUNT(*)
		FROM "BOARD_LIKE" L
		WHERE L.BOARD_NO =
		B.BOARD_NO) LIKE_COUNT,
		<![CDATA[
		CASE
		WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24 / 60
		THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60 * 60) || '초 전'
		WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24
		THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60) || '분 전'
		WHEN SYSDATE - BOARD_WRITE_DATE < 1
		THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24) || '시간 전'
		ELSE TO_CHAR(BOARD_WRITE_DATE, 'YYYY-MM-DD')
		END BOARD_WRITE_DATE
		]]>
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		ORDER BY BOARD_NO DESC
	</select>
	<!-- 검색 조건이 맞는 게시글 수 조회 -->
	<!-- 
		동적 SQL : <choose>, <when>, <otherwise> 
		
		<choose> : 조건문을 작성할 영역 지정
			내부에 <when>,  <otherwise> 태그 작성 가능
		<when> : if, else if 역할의 태그
			- test 속성 : 조건식을 작성하는 속성
		<otherwise> : else 역할의 태그
		<if test=""> : 단일 조건 
	-->
	<!-- 검색 조건이 맞는 게시글 수 조회 -->
   <select id="getSearchCount">
      SELECT COUNT(*)
      FROM "BOARD"
      <!-- 작성자 검색인 경우 -->
      <if test='key == "w"'>
         JOIN "MEMBER" USING(MEMBER_NO)
      </if>
      
	      WHERE BOARD_DEL_FL = 'N'
	      AND BOARD_CODE = #{boardCode}
      <choose>
         <!-- 제목 검색 (key 값 "t") -->
         <when test='key == "t"'>
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
         </when>
         
         <!-- 내용 검색 (key 값 "c") -->
         <when test='key == "t"'>
            AND BOARD_TITLE LIKE '%' || #{query} || '%'
         </when>
         
         <!-- 제목+내용 검색 (key 값 "tc") -->
         <when test='key == "t"'>
            AND (
               BOARD_CONTENT LIKE '%' || #{query} || '%'
               OR
               BOARD_TITLE LIKE '%' || #{query} || '%'
            )
         </when>
         
         <!-- 작성자 검색 (key 값 "w") -->
         <otherwise>
            AND MEMBER_NICKNAME LIKE '%' || #{query} || '%'
         </otherwise>
      </choose>
   </select>
	<!-- 검색 결과 목록 조회 -->
   <select id="selectSearchList">
   		SELECT BOARD_NO, BOARD_TITLE, MEMBER_NICKNAME,
		READ_COUNT,
		(SELECT
		COUNT(*)
		FROM "COMMENT" C
		WHERE C.BOARD_NO = B.BOARD_NO) COMMENT_COUNT,
		-- 상관쿼리(댓글개수),
		(SELECT COUNT(*)
		FROM "BOARD_LIKE" L
		WHERE L.BOARD_NO =
		B.BOARD_NO) LIKE_COUNT,
		<![CDATA[
		CASE
		WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24 / 60
		THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60 * 60) || '초 전'
		WHEN SYSDATE - BOARD_WRITE_DATE < 1 / 24
		THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24 * 60) || '분 전'
		WHEN SYSDATE - BOARD_WRITE_DATE < 1
		THEN FLOOR((SYSDATE - BOARD_WRITE_DATE) * 24) || '시간 전'
		ELSE TO_CHAR(BOARD_WRITE_DATE, 'YYYY-MM-DD')
		END BOARD_WRITE_DATE
		]]>
		FROM "BOARD" B
		JOIN "MEMBER" USING(MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		<choose>
	         <!-- 제목 검색 (key 값 "t") -->
	         <when test='key == "t"'>
	            AND BOARD_TITLE LIKE '%' || #{query} || '%'
	         </when>
	         
	         <!-- 내용 검색 (key 값 "c") -->
	         <when test='key == "t"'>
	            AND BOARD_TITLE LIKE '%' || #{query} || '%'
	         </when>
	         
	         <!-- 제목+내용 검색 (key 값 "tc") -->
	         <when test='key == "t"'>
	            AND (
	               BOARD_CONTENT LIKE '%' || #{query} || '%'
	               OR
	               BOARD_TITLE LIKE '%' || #{query} || '%'
	            )
	         </when>
	         
	         <!-- 작성자 검색 (key 값 "w") -->
	         <otherwise>
	            AND MEMBER_NICKNAME LIKE '%' || #{query} || '%'
	         </otherwise>
      </choose>
		ORDER BY BOARD_NO DESC
   	
   </select>
   
   <!--resultMap 태그 역할
   	1) 조회된 컬럼명과 DTO의 필드명이 일치하지 않을 때 매핑 시켜주는 역할
   	2) <collection> 태그를 추가 작성하여
       여러행 결과가 조회되는 다른 SELECT를 수행한 후
       그 결과를 지정된 DTO의 필드에 대입
    -->
   <resultMap type="Board" id="board_rm">
   	<!-- type은 연결한 쿼리의 return type을 의미 
   		id는 resultMap으로 정의된 것과 연결
   	-->
   		<id property="boardNo" column="BOARD_NO" />
   		<!-- column에서는 pk 역할을 넣어주면 됌 
   			=> 즉, from에서 정의된 테이블의 pk를 작성
   			property는 column을 어떻게 사용하는지 작성 => DTO에 정의된 필드명
   			즉, id는 pk를 연결
   		-->
   		
   		<!-- 
   			collection태그
   			SELECT로 조회된 결과를 컬렉션에 담아
   			지정된 필드에 세팅
   			
   			property : List를 담을 DTO의 필드명
			select : 실행할 select 의 id
			column : 조회 결과(부모쿼리 수행결과) 중 지정된 컬럼의 값을 파라미터로 전달
			javaType : List(컬렉션)의 타입을 지정
			ofType : List(컬렉션)의 제네릭(타입제한) 지정
   		 -->
   		 <!-- 해당 게시글 이미지 목록 조회 후 필드에 저장 -->
   		<!-- BoardImg 필드에 저장하고 리스트로 받아서 Board DTO의 imageList를 넣어준다-->
   		<collection 
   			property="imageList"
   			column="BOARD_NO"
   			select="selectImageList"
   			javaType="java.util.ArrayList" 
   			ofType="BoardImg"
   		/>
   		<!-- Comment DTO에 담고, List에 담아서 commentList에 넘겨주겠다는 의미 -->
   		<collection 
	   		property="commentList" 
	   		column="BOARD_NO" 
	   		select="selectCommentList"
	   		javaType="java.util.ArrayList"
	   		ofType="Comment"
   		/>
   		 
   </resultMap>
   
   <!-- resultMap의 collection태그를 이용한 sql 호출 시 반환 타입은 반드시
   		resultType 속성을 이용하여 명시해야함! (추론을 못하기 때문)
    -->
   
   <!-- 상세 조회한 게시글의 이미지 목록 조회 -->
   <!-- ${boardNo}는 id에서 정의한 boardNo, 즉 첫번 째 SQL문에서 넘어온 BOARD_NO을 의미 -->
   <select id="selectImageList" resultType="BoardImg">
   		SELECT * FROM "BOARD_IMG"
   		WHERE BOARD_NO = #{boardNo}
   		ORDER BY IMG_ORDER
   </select>
   <!-- 상세 조회한 게시글의 댓글 목록 조회(계층형 쿼리) -->
   <select id="selectCommentList" resultType="Comment">
   		SELECT LEVEL, C.* FROM
		(SELECT COMMENT_NO, COMMENT_CONTENT, 
			TO_CHAR(COMMENT_WRITE_DATE, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"') COMMENT_WRITE_DATE,
			BOARD_NO, MEMBER_NO, MEMBER_NICKNAME, PROFILE_IMG, PARENT_COMMENT_NO, COMMENT_DEL_FL
			FROM "COMMENT"
			JOIN MEMBER USING(MEMBER_NO)
			WHERE BOARD_NO = #{boardNo}) C
		WHERE COMMENT_DEL_FL = 'N' 
		OR 0 != (SELECT COUNT(*) FROM "COMMENT" SUB
						WHERE SUB.PARENT_COMMENT_NO = C.COMMENT_NO
						AND COMMENT_DEL_FL = 'N')
		START WITH PARENT_COMMENT_NO IS NULL 
		CONNECT BY PRIOR COMMENT_NO = PARENT_COMMENT_NO 
		ORDER SIBLINGS BY COMMENT_NO
   </select>
   <!-- 
   < 실행 순서 >
   1) selectOne을 수행 후=> imageList, commentList 안채워짐
   2) resultMap에 작성된 resultMap으로 이동
   3) id를 정의해주고, 위 2개의 List를 수행하기 위한 쿼리를 수행 => collection
    -->
   <!-- board_rm와 연결하겠다는 의미 -->
   <select id="selectOne" resultMap="board_rm">
   		SELECT BOARD_NO, BOARD_TITLE, BOARD_CONTENT, BOARD_CODE, READ_COUNT,
		MEMBER_NO, MEMBER_NICKNAME, PROFILE_IMG,
		TO_CHAR(BOARD_WRITE_DATE, 'YYYY"년" MM"월" DD"일" HH24:MI:SS') BOARD_WRITE_DATE,
		TO_CHAR(BOARD_UPDATE_DATE, 'YYYY"년" MM"월" DD"일" HH24:MI:SS') BOARD_UPDATE_DATE,
		
		(SELECT COUNT(*)
		FROM "BOARD_LIKE"
		WHERE BOARD_NO = #{boardNo}) LIKE_COUNT,
		
		(SELECT IMG_PATH || IMG_RENAME
		FROM "BOARD_IMG"
		WHERE BOARD_NO = #{boardNo}
		AND IMG_ORDER = 0 ) THUMBNAIL,
		
		(SELECT COUNT(*)
		FROM "BOARD_LIKE"
		WHERE BOARD_NO = #{boardNo}
		AND MEMBER_NO = #{memberNo}) LIKE_CHECK
		
		FROM "BOARD"
		JOIN "MEMBER" USING(MEMBER_NO)
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_CODE = #{boardCode}
		AND BOARD_NO = #{boardNo}
   </select>
   <update id="updateReadCount">
   		UPDATE "BOARD"
   		SET READ_COUNT = READ_COUNT + 1
   		WHERE BOARD_NO = #{boardNo}
   </update>
   <select id="selectReadCount">
   		SELECT READ_COUNT
   		FROM "BOARD"
   		WHERE BOARD_NO = #{boardNo}   
   </select>
   <!-- 좋아요 해제 SQL (DELETE) -->
   <delete id="deleteBoardLike">
   		DELETE FROM "BOARD_LIKE"
   		WHERE MEMBER_NO = #{memberNo}
   		AND BOARD_NO = #{boardNo}
   </delete>
   <!-- 좋아요 체크 SQL (INSERT) -->
   <insert id="insertBoardLike">
   		INSERT INTO "BOARD_LIKE"
   		VALUES(#{memberNo}, #{boardNo})
   </insert>
   <!-- 게시글 좋아요 갯수 조회 (SELECT) -->
   <select id="selectLikeCount">
   		SELECT COUNT(*)
   		FROM "BOARD_LIKE"
   		WHERE BOARD_NO = #{boardNo}
   </select>
   
</mapper>
